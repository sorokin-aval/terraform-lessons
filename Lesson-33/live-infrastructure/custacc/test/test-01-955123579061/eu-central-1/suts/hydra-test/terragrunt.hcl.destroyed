# IT Customers and Account Services Delivery 
# !!! DESTROYED 2022-09-09 14:20 bsh

include {
  path   = find_in_parent_folders()
  expose = true
}

iam_role = local.account_vars.iam_role

dependency "vpc" {
  config_path = find_in_parent_folders("core-infrastructure/vpc-info")
}

terraform {
  source = "git::https://code.rbi.tech/raiffeisen/ua-tf-aws-payments-host.git//?ref=v1.1.1"
  #  source = find_in_parent_folders("../../localmodules/ua-tf-aws-payments-host")
  #  source = include.locals.account_vars.locals.sources["host"]
  #  source = find_in_parent_folders("../../modules/host")

}

locals {
  account_vars = read_terragrunt_config(find_in_parent_folders("account.hcl"))
  app_vars     = read_terragrunt_config(find_in_parent_folders("application.hcl"))
  name         = basename(get_terragrunt_dir())
}

inputs = {
  vpc    = include.locals.account_vars.locals.vpc
  domain = include.locals.account_vars.locals.domain
  name   = local.name
  ami  = "ami-06b2ef9719c20121c"
  type = "t2.medium"

  subnet = "*-InternalA"
  zone   = "eu-central-1a"

  #  root_block_device = [
  #    {
  #      volume_size = "24"
  #      volume_type = "gp3"
  #      tags  = local.common_tags
  #    }
  #  ]
  #
  #      ebs_block_device = [ {
  #          delete_on_termination = true
  #          device_name           = "/dev/sdf"
  #          encrypted             = false
  #          iops                  = 3000
  #          snapshot_id           = "snap-0bf37e209e11ab23b"
  ##          tags                  = {local.common_tags.locals}
  #          throughput            = 125
  #          volume_id             = "vol-04df1ca851abf1996"
  #          volume_size           = 250
  #          volume_type           = "gp3"
  #        }
  #      , {
  #          delete_on_termination = true
  #          device_name           = "/dev/sdg"
  #          encrypted             = false
  #          iops                  = 3000
  #          snapshot_id           = "snap-0ef4ba8c8ad51d75e"
  ##          tags                  = {local.common_tags.locals}
  #          throughput            = 125
  #          volume_id             = "vol-0aee83e3336af1c87"
  #          volume_size           = 250
  #          volume_type           = "gp3"
  #        }
  #      , {
  #          delete_on_termination = true
  #          device_name           = "/dev/sdh"
  #          encrypted             = false
  #          iops                  = 3000
  #          snapshot_id           = "snap-086c11eb1c4c269a5"
  ##          tags                  = {local.common_tags.locals}
  #          throughput            = 125
  #          volume_id             = "vol-0d0c987455f41e726"
  #          volume_size           = 250
  #          volume_type           = "gp3"
  #        }
  #      , {
  #          delete_on_termination = true
  #          device_name           = "/dev/sdi"
  #          encrypted             = false
  #          iops                  = 3000
  #          snapshot_id           = "snap-011266317a5f5a2d4"
  #          tags                  = {local.common_tags.locals}
  #          throughput            = 125
  #          volume_id             = "vol-0d0a58293b90cb2e7"
  #          volume_size           = 250
  #          volume_type           = "gp3"
  #        }
  #] 

  #  security_groups = ["zabbix-agent"]

  tags = merge(local.app_vars.locals.tags, {
    application_role = "NIFI",
    application_role = local.app_vars.locals.name,
    map-migrated     = "d-server-033cr76wnondl7",
  Backup = "Daily-3day-Retention" })
  ingress = [
    { from_port : 22, to_port : 22, protocol : "tcp", cidr_blocks : ["10.0.0.0/8"], description : "SSH" },
    { from_port : 3389, to_port : 3389, protocol : "tcp", cidr_blocks : ["10.0.0.0/8"], description : "RDP" },
  ]
  egress = [
    { from_port : 0, to_port : 0, protocol : "-1", cidr_blocks : ["10.0.0.0/8"], description : "ALL OUT" },
    { from_port : 443, to_port : 443, protocol : "tcp", cidr_blocks : ["0.0.0.0/0"], description : "HTTPS2SSM OUT" },
  ]
}
